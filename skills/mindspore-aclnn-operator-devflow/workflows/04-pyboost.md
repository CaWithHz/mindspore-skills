# Workflow 4: PyBoost（Pynative, C++）

## 目标

实现 Pynative 路径下的 ACLNN 算子调用。
**根据接入路径不同，本步骤工作量差异很大：**
- **路径 1（自动生成）**：gen_ops.py 已生成完整调用代码，此步只需**验证**
- **路径 2（Customize）**：需要在 customize 目录手写实现文件

## 输入

- **接入路径**：Pre-B 确定的路径 1 或路径 2
- **YAML 定义**：参数列表、dispatch 配置
- **PTA 源码分析**：ACLNN 调用细节、参数预处理逻辑
- **（组合场景）ACLNN 调用链**：子算子列表与依赖关系

## 输出

- **路径 1**：验证自动生成的 PyBoost 调用代码正确
- **路径 2**：手写 PyBoost 实现文件 `op_name_ascend_customize.cc/.h`
- **（反向）PyBoost Grad 实现文件（路径 2）**

---

## 执行步骤

### 路径 1 分支：验证自动生成产物

> 如果 Pre-B 确定为路径 1（参数直通），**不需要手写 PyBoost 文件**。
> 只需验证 gen_ops.py 自动生成的调用代码正确：

1. **确认生成代码存在**：检查自动生成目录下有对应的 PyBoost 调用模板产物
2. **确认 ACLNN 调用参数正确**：自动生成的 `LAUNCH_ACLNN(aclnnXxx, ...)` 参数顺序/类型无误
3. **编译验证**：确保自动生成代码编译通过
4. 验证通过后，直接进入 [Workflow 5: KBK](./05-kbk.md)

> **如果验证发现自动生成代码有问题**（参数不匹配等），
> 说明参数无法直通，需要重新评估→改为路径 2。

### 路径 2 分支：手写 Customize 文件

#### Step 0：ACLNN 接口核对（反幻觉）

> 若 Pre-B/Pre-C 阶段已确认接口信息（用户贴过文档、PTA 源码已分析），直接引用之前的结论即可，跳过本步。

当准备调用一个之前未确认过的 ACLNN 接口时，先核实：
1. **grep 搜索**：`grep -r "aclnnXxx" .` 尝试寻找项目内的已有调用或头文件定义。
2. **确认签名**：
   - **若搜到**：提取参数列表（尤其是 workspace 参数位置）。
   - **若未搜到**（新算子/头文件不在工程内/宏拼接）：**禁止猜测**，请用户提供 ACLNN 接口文档或头文件定义片段。
3. **记录证据**：向用户展示查到的代码引用或用户提供的文档内容。

#### Step 1：单算子直连模式

标准三段式（`reference.md` §5）：
1. 输出 tensor 分配
2. 参数转换（tuple→vector / None 处理等）
3. ACLNN 两段式调用（`LAUNCH_ACLNN` 或项目等价宏）

### Step 2：组合算子模式（多 ACLNN 串联）

当 PTA 用多个小算子串联时（`reference.md` §29.1）：
1. 每个子算子调用一次 `LAUNCH_ACLNN`
2. 中间 tensor **手动分配**（shape 需自行推导）
3. 中间 tensor 生命周期仅限本函数
4. stream 在同一上下文中顺序执行

### Step 3：输入参数转换（`reference.md` §5.1）

- tuple/list → `std::vector<int64_t>`
- 可选输入 None → 定义 None 语义，PyBoost/Infer/KBK 同步处理
- 标量参数 → 按项目封装提取

### Step 4：对照相似算子（以仓库现状为准）

**必须**参考同目录下相似算子的现有代码文件，确保宏/工具函数用法一致。
> ⚠️ 宏名、头文件、工具函数可能随版本变化。不要照搬 reference.md 中的示例，
> 以 `customize/` 目录下最新的已有算子代码为准。

代码骨架见 `reference.md` §24.3（单算子）/ §29.1（组合），但**以仓库实际代码为最终参考**。

---

## 成功标准

**路径 1**：
- [ ] 确认自动生成的 PyBoost 调用代码存在且参数正确
- [ ] 编译通过

**路径 2**：
- [ ] PyBoost 前向 Customize 实现完成，编译通过
- [ ] PyBoost 反向 Customize 实现完成（如需要），编译通过
- [ ] 参数转换正确（tuple/None/标量）
- [ ] 组合场景：中间 tensor 分配正确，调用顺序与 PTA 一致
- [ ] 风格与同目录已有实现一致

---

## 下一步

PyBoost 完成后，进入 **[Workflow 5: KBK](./05-kbk.md)**
